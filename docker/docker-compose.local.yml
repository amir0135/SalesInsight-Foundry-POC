# =============================================================================
# Chat With Your Data - Docker Compose Setup
# =============================================================================
# Quick start: docker-compose up
# 
# This runs the full application stack locally. You still need Azure resources
# for OpenAI, Search, and Storage - but everything else runs in containers.
# =============================================================================

name: chat-with-your-data

services:
  # ===========================================================================
  # Main Chat Application (Flask API + React Frontend)
  # ===========================================================================
  web:
    build:
      context: ..
      dockerfile: docker/Frontend.Dockerfile
    ports:
      - "8080:80"
    environment:
      - BACKEND_URL=http://functions:80
      - WEBSITES_PORT=80
    env_file:
      - ../.env
    depends_on:
      - functions
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ===========================================================================
  # Admin UI (Streamlit - Document Upload & Configuration)
  # ===========================================================================
  admin:
    build:
      context: ..
      dockerfile: docker/Admin.Dockerfile
    ports:
      - "8501:80"
    environment:
      - BACKEND_URL=http://functions:80
      - FUNCTION_KEY=local-dev-key
    env_file:
      - ../.env
    depends_on:
      - functions
    restart: unless-stopped

  # ===========================================================================
  # Azure Functions (Background Processing)
  # ===========================================================================
  functions:
    build:
      context: ..
      dockerfile: docker/Backend.Dockerfile
    ports:
      - "7071:80"
    environment:
      - AzureWebJobsSecretStorageType=files
      - FUNCTIONS_WORKER_RUNTIME=python
    env_file:
      - ../.env
    volumes:
      - ./function-host.json:/azure-functions-host/Secrets/host.json
    restart: unless-stopped

  # ===========================================================================
  # PostgreSQL (Local Chat History & Database Testing)
  # ===========================================================================
  postgres:
    image: postgres:15-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=chathistory
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

volumes:
  postgres_data:
